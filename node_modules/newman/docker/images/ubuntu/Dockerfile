FROM ubuntu:22.04
LABEL maintainer="Postman Labs <help@postman.com>"

ARG NODE_MAJOR=16
ARG NEWMAN_VERSION

# Validar versiÃ³n, instalar dependencias y newman, crear usuario
RUN if [ -z "${NEWMAN_VERSION}" ] || ! echo "${NEWMAN_VERSION}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then \
      echo "A valid semver Newman version is required in the NEWMAN_VERSION build-arg" >&2; \
      exit 1; \
    fi && \
    apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates curl gnupg && \
    mkdir -p /etc/apt/keyrings && \
    curl --proto '=https' --tlsv1.2 -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | \
      gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_${NODE_MAJOR}.x nodistro main" | \
      tee /etc/apt/sources.list.d/nodesource.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends nodejs && \
    npm install --global newman@"${NEWMAN_VERSION}" && \
    useradd -m -s /bin/bash newmanuser && \
    mkdir -p /etc/newman && \
    chown -R newmanuser:newmanuser /etc/newman && \
    apt-get clean && rm -rf /var/lib/apt/lists/*


# Cambiar a usuario no-root
USER newmanuser

# Variables de entorno
ENV LC_ALL="en_US.UTF-8" LANG="en_US.UTF-8" LANGUAGE="en_US.UTF-8"

# Set workdir to /etc/newman
# When running the image, mount the directory containing your collection to this location
#
# docker run -v <path to collections directory>:/etc/newman ...
#
# In case you mount your collections directory to a different location, you will need to give absolute paths to any
# collection, environment files you want to pass to newman, and if you want newman reports to be saved to your disk.
# Or you can change the workdir by using the -w or --workdir flag
WORKDIR /etc/newman

# Set newman as the default container command
# Now you can run the container via
#
# docker run -v /home/collections:/etc/newman -t postman/newman_ubuntu run YourCollection.json.postman_collection \
#                                                                          -e YourEnvironment.postman_environment \
#                                                                          -H newman_report.html
ENTRYPOINT ["newman"]
